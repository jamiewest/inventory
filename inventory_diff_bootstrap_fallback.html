<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory Manager & Change Log (Bootstrap + Offline Fallback)</title>
<!-- Primary Bootstrap CDN -->
<link id="bs-css-1" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Secondary CDNs (will be enabled if primary fails) -->
<link id="bs-css-2" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet" disabled>
<link id="bs-css-3" href="https://unpkg.com/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" disabled>
<style>
  /* Minimal fallback styling if all CDNs fail */
  :root { color-scheme: light; }
  body { background-color:#f5f7fb; color:#1f2933; }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .table-fixed-head thead th { position: sticky; top: 0; z-index: 2; }
  .scroll-pane { max-height: 60vh; overflow: auto; }
  .menu-spacer { height: 56px; }
  .vis-hide { display: none !important; }
  .fallback .navbar { position:fixed; top:0; left:0; right:0; background:#ffffff; border-bottom:1px solid #d0d7de; padding:.5rem 1rem; }
  .fallback .navbar a { color:#1f2933; text-decoration:none; margin-right:1rem; }
  .fallback .container-fluid, .fallback .container { padding: 0 1rem; }
  .fallback .card { border:1px solid #d0d7de; background:#ffffff; border-radius:.5rem; margin-bottom:1rem; }
  .fallback .card-header, .fallback .card-footer { padding:.75rem 1rem; border-bottom:1px solid #d0d7de; }
  .fallback .card-body { padding:1rem; }
  .fallback .btn { padding:.4rem .6rem; border:1px solid #c2c8d0; background:#f3f5f8; color:#1f2933; border-radius:.4rem; cursor:pointer; }
  .fallback .btn-primary { background:#0d6efd; color:#ffffff; border-color:#0d6efd; }
  .fallback .btn-outline-secondary,
  .fallback .btn-outline-dark { background:transparent; color:#1f2933; border-color:#c2c8d0; }
  .fallback .btn-outline-danger { background:transparent; color:#b42318; border-color:#e29f9e; }
  .fallback .badge { display:inline-block; padding:.2rem .4rem; border:1px solid #d0d7de; border-radius:.4rem; color:#4a5563; }
  .fallback table { width:100%; border-collapse:collapse; }
  .fallback th, .fallback td { border-bottom:1px solid #e5e9f2; padding:.5rem; vertical-align:top; }
  .fallback .toast-save { position: fixed; right: 1rem; bottom: 1rem; background:#ffffff; border:1px solid #d0d7de; padding:.4rem .6rem; border-radius:.4rem; }
  .fallback .ms-1 { margin-left:.25rem; }
  /* Custom modal fallback */
  .modal-fb { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
  .modal-fb.show { display:flex; }
  .modal-fb .panel { width:min(560px,95vw); background:#ffffff; border:1px solid #d0d7de; border-radius:.6rem; overflow:hidden; }
  .modal-fb header, .modal-fb .actions { padding:.75rem 1rem; border-bottom:1px solid #d0d7de; }
  .modal-fb .content { padding:1rem; }
  .form-grid { display:grid; grid-template-columns:1fr; gap:.5rem; }
  @media(min-width:760px){ .form-grid { grid-template-columns: 1fr 1fr; } .form-grid .full { grid-column:1 / -1; } }
  .input, select, textarea { width:100%; padding:.5rem .6rem; border:1px solid #c2c8d0; border-radius:.4rem; background:#ffffff; color:#1f2933; }
  .notes-pre { background:#f3f4f6; padding:.75rem; border-radius:.5rem; max-height:240px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .notes-list ol { padding-left:1.25rem; margin-bottom:0; }
  .notes-list li + li { margin-top:.5rem; }
  .notes-list time { display:block; font-size:.875rem; color:#64748b; }
  #localTable { font-size: clamp(.78rem, .74rem + .25vw, .95rem); }
  #localTable th { font-size: clamp(.7rem, .66rem + .22vw, .85rem); }
  #localTable td { line-height: 1.35; }
  #viewAssetModal td { white-space: pre-wrap; }
.sortable { cursor:pointer; user-select:none; }
  .sortable .sort-indicator { margin-left:.25rem; font-size:.75rem; color:#94a3b8; }
  .sortable.sorted .sort-indicator { color:#0d6efd; }
  #localTable td { word-break: break-word; }
  #localTable td[data-k="meta"] { white-space: nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 160px; display:none; }
  #localTable td.note-actions { white-space: nowrap; vertical-align: middle; }
  #localTable td.note-actions .btn { padding:.25rem .55rem; font-size:.75rem; }
  #lastSaved { white-space: nowrap; }

  .header-actions { display:flex; gap:.5rem; }
  .header-actions .btn { white-space: nowrap; }
  .card-header.flex-responsive { display:flex; align-items:center; gap:.75rem; }
  .card-header.flex-responsive .header-title { display:flex; align-items:center; flex-wrap:wrap; gap:.5rem; }
  .card-header.flex-responsive .header-actions { margin-left:auto; }
  @media (max-width: 992px){
    .card-header.flex-responsive { flex-direction:column; align-items:flex-start; }
    .card-header.flex-responsive .header-actions { width:100%; flex-wrap:wrap; margin-left:0; }
    .card-header.flex-responsive .header-actions .btn { flex:1 1 160px; }
    #localTable { font-size: clamp(.72rem, .68rem + .2vw, .88rem); }
    #localTable th { font-size: clamp(.66rem, .62rem + .18vw, .8rem); }
  }
  @media (max-width: 768px){
    #localTable { font-size: clamp(.68rem, .64rem + .18vw, .82rem); }
    #localTable th { font-size: clamp(.6rem, .56rem + .16vw, .76rem); }
  }
  @media (max-width: 576px){
    #localTable td.note-actions { display:flex; flex-direction:column; gap:.25rem; align-items:stretch; }
    #localTable td.note-actions .btn { width:100%; }
    #localTable td.note-actions .btn.ms-1 { margin-left:0; }
    #localTable { font-size: clamp(.64rem, .6rem + .16vw, .78rem); }
    #localTable th { font-size: clamp(.58rem, .54rem + .14vw, .72rem); }
    .card-header.flex-responsive .header-actions .btn { flex:1 0 calc(50% - .25rem); }
  }
  .fallback .d-none { display:none !important; }
  .fallback .header-actions { flex-wrap:wrap; gap:.5rem; }
  .fallback .header-actions .btn { flex:1 0 calc(50% - .25rem); }
  .fallback .note-actions { white-space:normal; display:flex; flex-direction:column; gap:.25rem; }
  .fallback .note-actions .btn { width:100%; }
  .fallback .d-none { display:none !important; }
  #viewAssetFormWrap { margin-top:1rem; }
  .fallback .sortable { cursor:pointer; }
  .fallback .sortable .sort-indicator { color:#6b7280; }
  .fallback .sortable.sorted .sort-indicator { color:#0d6efd; }
  #addModal .form-control::placeholder,
  #addModal textarea.form-control::placeholder {
    font-size:.85em;
    color:#9ca3af;
    font-weight:400;
  }
  #fallbackModal .input::placeholder,
  #fallbackModal textarea.input::placeholder {
    font-size:.85em;
    color:#9ca3af;
    font-weight:400;
  }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top border-bottom">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="#inventory">Inventory</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav" aria-controls="topNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#inventory">Inventory</a></li>
        <li class="nav-item"><a class="nav-link" href="#diff">Change Log</a></li>
        <li class="nav-item"><a class="nav-link" href="#statuses">Settings</a></li>
      </ul>
      
    </div>
  </div>
</nav>
<div class="menu-spacer"></div>

<main class="container-fluid py-3">

  <!-- INVENTORY PAGE -->
  <section id="page-inventory" class="vis-hide">
    <div class="row g-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header d-flex align-items-center flex-responsive">
            <div class="header-title">
              <h5 class="mb-0">Inventory</h5>
            </div>
            <div class="header-actions">
              <button class="btn btn-primary btn-sm" id="openAdd">Add asset</button>
              <button class="btn btn-outline-danger btn-sm" id="deleteSelected">Delete selected</button>
              <button class="btn btn-outline-secondary btn-sm" id="clearAll">Clear all</button>
              <button class="btn btn-outline-primary btn-sm" id="seedSample" title="Populate with example data">Seed sample data</button>
            </div>
          </div>
          <div class="card-body pt-2">
            <div class="row g-2 align-items-end mb-3" id="localToolbar">
              <div class="col-12 col-lg-5">
                <label for="localSearch" class="form-label mb-1">Search inventory</label>
                <input id="localSearch" class="form-control form-control-sm" placeholder="Search id, serial, asset tag, assigned, status…"/>
              </div>
              <div class="col-6 col-lg-3">
                <label for="localStatusFilter" class="form-label mb-1">Status filter</label>
                <select id="localStatusFilter" class="form-select form-select-sm">
                  <option value="">All statuses</option>
                </select>
              </div>
              <div class="col-6 col-lg-2">
                <label for="localPageSize" class="form-label mb-1">Rows per page</label>
                <select id="localPageSize" class="form-select form-select-sm">
                  <option value="10">10</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="all">All</option>
                </select>
              </div>
              <div class="col-12 col-lg-2 d-none d-lg-block text-lg-end text-secondary small">
                <span>Tip: click column headers to sort</span>
              </div>
            </div>
            <div id="localFilterStatus" class="small text-secondary mb-2" role="status" aria-live="polite"></div>
            <div class="table-responsive scroll-pane table-fixed-head border rounded">
              <table class="table table-sm align-middle mb-0" id="localTable">
                <thead class="table-light">
                  <tr>
                    <th style="width:36px;"><input class="form-check-input" type="checkbox" id="selAll"></th>
                    <th class="sortable" data-sort="id"><span>ID</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="serial_number"><span>Serial Number</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="asset_tag"><span>Asset Tag</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="type"><span>Type</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="model"><span>Model</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="room"><span>Cubicle / Office / Room</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="assigned_to"><span>Assigned To</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable" data-sort="status"><span>Status</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="sortable d-none" data-sort="meta"><span>Meta</span><span class="sort-indicator" aria-hidden="true"></span></th>
                    <th class="text-center text-nowrap">Actions</th>
                  </tr>
                </thead>
                <tbody id="localBody"></tbody>
              </table>
            </div>
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mt-2 gap-2" id="localPaginationBar">
              <div id="localPaginationInfo" class="small text-secondary"></div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="localPrevPage">Previous</button>
                <button class="btn btn-outline-secondary btn-sm" id="localNextPage">Next</button>
              </div>
            </div>
            <div id="localImportStatus" class="small text-secondary mt-2" role="status" aria-live="polite"></div>
          </div>
          <div class="card-footer d-flex gap-2 align-items-center flex-wrap">
            <div class="d-flex gap-2">
              <label class="btn btn-outline-dark btn-sm mb-0" for="loadLocalFile">Import Local JSON/CSV</label>
              <input type="file" id="loadLocalFile" accept=".json,.csv,text/csv,application/json" hidden/>
              <button class="btn btn-outline-dark btn-sm" id="saveLocalJson">Export Local JSON</button>
              <button class="btn btn-outline-dark btn-sm" id="saveLocalCsv">Export Local CSV</button>
            </div>
            <div class="ms-auto small text-secondary" id="lastSaved">Not yet saved</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STATUSES PAGE -->
  <section id="page-statuses" class="vis-hide">
    <div class="card shadow-sm">
      <div class="card-header"><h5 class="mb-0">Status Options</h5></div>
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-12 col-md-9">
            <label for="statusOptions" class="form-label">Statuses (comma-separated)</label>
            <input id="statusOptions" class="form-control" placeholder="e.g. Disposed, Initial, Installed, Returned, Shipped, Stored"/>
            <div class="text-secondary mt-1">Used to populate the Add modal’s dropdown. You can still type custom statuses in the modal.</div>
          </div>
          <div class="col-12 col-md-3 d-grid d-md-flex align-items-end">
            <button class="btn btn-primary w-100" id="saveStatus">Save Status Options</button>
          </div>
        </div>
        <div class="mt-2">
          <span id="statusSaved" class="badge text-bg-secondary">Not saved</span>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <a class="btn btn-outline-dark" href="#inventory">← Back to Inventory</a>
        <a class="btn btn-success" href="#diff">Go to Change Log →</a>
      </div>
    </div>
  </section>

  <!-- DIFF PAGE -->
  <section id="page-diff" class="vis-hide">
        <div class="card shadow-sm">
          <div class="card-header"><h5 class="mb-0">Change Log</h5></div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-lg-4">
                <div class="card shadow-sm mb-3">
                  <div class="card-header d-flex align-items-center">
                    <h6 class="mb-0">Inventory</h6>
                    <div class="ms-auto">
                      <button class="btn btn-outline-secondary btn-sm" id="clearOfficial">Clear</button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="d-flex gap-2 align-items-center mb-2">
                      <label class="btn btn-outline-dark btn-sm mb-0" for="loadOfficialCsv">Import CSV</label>
                      <input type="file" id="loadOfficialCsv" accept=".csv,text/csv" hidden/>
                      <span id="officialStats" class="badge text-bg-secondary">No file loaded</span>
                    </div>
                    <p class="text-secondary mb-2">CSV must include header <span class="code">id</span>.</p>
                    <div id="officialImportStatus" class="small text-secondary mb-2" role="status" aria-live="polite"></div>
                    <div id="officialPreviewWrap" class="vis-hide">
                      <div class="table-responsive scroll-pane table-fixed-head border rounded">
                        <table class="table table-sm mb-0" id="officialPreview">
                          <thead></thead><tbody></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card bg-body-secondary border-0">
                  <div class="card-body">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="emptyClears">
                  <label class="form-check-label" for="emptyClears">Empty means “clear field”</label>
                </div>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="ignoreMeta">
                  <label class="form-check-label" for="ignoreMeta">Ignore <span class="code">meta</span> field</label>
                </div>
                <p class="text-secondary">Compared fields: <span class="code">serial_number</span>, <span class="code">asset_tag</span>, <span class="code">type</span>, <span class="code">model</span>, <span class="code">room</span>, <span class="code">assigned_to</span>, <span class="code">status</span>, <span class="code">meta</span> (by <span class="code">id</span>).</p>
                <div class="d-grid gap-2">
                  <button class="btn btn-primary" id="btnDiff">Generate Change Log</button>
                </div>
                <div class="mt-2">
                  <span id="diffStats" class="badge text-bg-secondary">No diff yet</span>
                </div>
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-outline-dark" id="downloadCsv" disabled>Download CSV</button>
              <button class="btn btn-outline-dark" id="copyMd" disabled>Copy Markdown</button>
            </div>
          </div>
          <div class="col-12 col-lg-8">
            <div class="table-responsive scroll-pane table-fixed-head border rounded">
              <table class="table table-sm mb-0" id="diffTable">
                <thead class="table-light">
                  <tr>
                    <th>Action</th><th>Tag</th><th>Field</th><th>OldValue</th><th>NewValue</th><th>Notes</th>
                  </tr>
                </thead>
                <tbody id="diffBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </section>

</main>

<!-- Add Asset Modal (Bootstrap) -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTitle">Add Asset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="m_id" class="form-label">ID *</label>
            <input id="m_id" class="form-control" placeholder="required"/>
          </div>
          <div class="col-12 col-md-6">
            <label for="m_serial_number" class="form-label">Serial Number</label>
            <input id="m_serial_number" class="form-control" placeholder="optional"/>
          </div>
          <div class="col-12 col-md-6">
            <label for="m_asset_tag" class="form-label">Asset Tag</label>
            <input id="m_asset_tag" class="form-control" placeholder="optional"/>
          </div>
          <div class="col-12 col-md-6">
            <label for="m_type" class="form-label">Type</label>
            <input id="m_type" class="form-control" placeholder="optional"/>
          </div>
          <div class="col-12 col-md-6">
            <label for="m_model" class="form-label">Model</label>
            <input id="m_model" class="form-control" placeholder="optional"/>
          </div>
          <div class="col-12 col-md-6">
            <label for="m_room" class="form-label">Cubicle / Office / Room</label>
            <input id="m_room" class="form-control" placeholder="optional"/>
          </div>
          <div class="col-12 col-md-6">
            <label for="m_assigned_to" class="form-label">Assigned To</label>
            <input id="m_assigned_to" class="form-control" placeholder="optional"/>
          </div>
          <div class="col-12">
            <label class="form-label">Status</label>
            <div class="input-group">
              <select id="m_status" class="form-select"></select>
              <input id="m_status_custom" class="form-control" placeholder="or type custom…"/>
            </div>
            <div class="text-secondary">Choose from the list or type your own.</div>
          </div>
          <div class="col-12">
            <label for="m_meta" class="form-label">Meta (JSON or text)</label>
            <textarea id="m_meta" class="form-control" rows="3" placeholder='e.g. {"color":"black","cost":999}'></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAdd">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- Fallback Modal (if Bootstrap JS unavailable) -->
<div id="fallbackModal" class="modal-fb" aria-hidden="true">
  <div class="panel">
    <header><strong>Add Asset</strong></header>
    <div class="content">
      <div class="form-grid">
        <div>
          <label>ID *</label>
          <input id="fb_id" class="input" placeholder="required"/>
        </div>
        <div>
          <label>Serial Number</label>
          <input id="fb_serial_number" class="input" placeholder="optional"/>
        </div>
        <div>
          <label>Asset Tag</label>
          <input id="fb_asset_tag" class="input" placeholder="optional"/>
        </div>
        <div>
          <label>Type</label>
          <input id="fb_type" class="input" placeholder="optional"/>
        </div>
        <div>
          <label>Model</label>
          <input id="fb_model" class="input" placeholder="optional"/>
        </div>
        <div>
          <label>Cubicle / Office / Room</label>
          <input id="fb_room" class="input" placeholder="optional"/>
        </div>
        <div>
          <label>Assigned To</label>
          <input id="fb_assigned_to" class="input" placeholder="optional"/>
        </div>
        <div class="full">
          <label>Status</label>
          <div style="display:flex; gap:.5rem;">
            <select id="fb_status" class="input"></select>
            <input id="fb_status_custom" class="input" placeholder="or type custom…"/>
          </div>
        </div>
        <div class="full">
          <label>Meta (JSON or text)</label>
          <textarea id="fb_meta" class="input" rows="3" placeholder='e.g. {"color":"black","cost":999}'></textarea>
        </div>
      </div>
    </div>
    <div class="actions" style="display:flex; gap:.5rem; justify-content:flex-end; padding:.75rem 1rem;">
      <button class="btn" id="fb_cancel">Cancel</button>
      <button class="btn btn-primary" id="fb_confirm">Add</button>
    </div>
  </div>
</div>

<!-- View Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notesTitle">Asset Notes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="notesList" class="notes-list mb-3"></div>
        <div>
          <div class="small text-secondary mb-1">Meta JSON</div>
          <pre id="notesMetaJson" class="notes-pre"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalTitle">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="noteText" class="form-label">Note</label>
          <textarea id="noteText" class="form-control" rows="4" placeholder="Enter details..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="noteModalSave">Save note</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Meta Modal -->
<div class="modal fade" id="metaModal" tabindex="-1" aria-labelledby="metaModalTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="metaModalTitle">Meta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="metaModalText" class="form-label">Meta (stored as text/JSON)</label>
        <textarea id="metaModalText" class="form-control" rows="6" placeholder='e.g. {"color":"black"}'></textarea>
        <div class="form-text">Leave blank to clear. JSON is optional.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="metaModalSave">Save meta</button>
      </div>
    </div>
  </div>
</div>



<!-- View Asset Modal -->
<div class="modal fade" id="viewAssetModal" tabindex="-1" aria-labelledby="viewAssetModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewAssetModalTitle">Asset Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="viewAssetReadOnly">
          <table class="table table-sm table-striped mb-0">
            <tbody id="viewAssetDetails"></tbody>
          </table>
        </div>
        <div id="viewAssetFormWrap" class="d-none">
          <form id="viewAssetForm" autocomplete="off" novalidate>
            <p class="small text-secondary mb-2">Edit mode is active. Update the fields below and select “Save changes”.</p>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="view_edit_id" class="form-label">ID *</label>
                <input id="view_edit_id" class="form-control" type="text" required/>
              </div>
              <div class="col-12 col-md-6">
                <label for="view_edit_serial_number" class="form-label">Serial Number</label>
                <input id="view_edit_serial_number" class="form-control" type="text"/>
              </div>
              <div class="col-12 col-md-6">
                <label for="view_edit_asset_tag" class="form-label">Asset Tag</label>
                <input id="view_edit_asset_tag" class="form-control" type="text"/>
              </div>
              <div class="col-12 col-md-6">
                <label for="view_edit_type" class="form-label">Type</label>
                <input id="view_edit_type" class="form-control" type="text"/>
              </div>
              <div class="col-12 col-md-6">
                <label for="view_edit_model" class="form-label">Model</label>
                <input id="view_edit_model" class="form-control" type="text"/>
              </div>
              <div class="col-12 col-md-6">
                <label for="view_edit_room" class="form-label">Cubicle / Office / Room</label>
                <input id="view_edit_room" class="form-control" type="text"/>
              </div>
              <div class="col-12 col-md-6">
                <label for="view_edit_assigned_to" class="form-label">Assigned To</label>
                <input id="view_edit_assigned_to" class="form-control" type="text"/>
              </div>
              <div class="col-12">
                <label class="form-label" for="view_edit_status">Status</label>
                <div class="input-group">
                  <select id="view_edit_status" class="form-select"></select>
                  <input id="view_edit_status_custom" class="form-control" type="text" placeholder="or type custom…"/>
                </div>
                <div class="text-secondary small">Choose from the list or type your own.</div>
              </div>
              <div class="col-12">
                <label for="view_edit_meta" class="form-label">Meta (JSON or text)</label>
                <textarea id="view_edit_meta" class="form-control" rows="3" placeholder='e.g. {"color":"black","cost":999}'></textarea>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer justify-content-between align-items-center flex-wrap gap-2">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <div class="d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-outline-secondary d-none" id="viewAssetCancelEdit">Cancel</button>
          <button type="submit" class="btn btn-primary d-none" id="viewAssetSave" form="viewAssetForm">Save changes</button>
          <button type="button" class="btn btn-outline-dark" id="viewAssetEdit">Enter edit mode</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Notes fallback (if Bootstrap JS unavailable) -->
<div id="notesFallback" class="modal-fb" aria-hidden="true">
  <div class="panel">
    <header id="notesFallbackTitle"><strong>Asset Notes</strong></header>
    <div class="content">
      <div id="notesFallbackContent" class="small"></div>
    </div>
    <div class="actions" style="display:flex; gap:.5rem; justify-content:flex-end; padding:.75rem 1rem;">
      <button class="btn" id="notesFallbackClose">Close</button>
    </div>
  </div>
</div>

<!-- Note input fallback -->
<div id="noteFallback" class="modal-fb" aria-hidden="true">
  <div class="panel">
    <header id="noteFallbackTitle"><strong>Add Note</strong></header>
    <div class="content">
      <textarea id="noteFallbackText" class="input" rows="4" placeholder="Enter details..."></textarea>
    </div>
    <div class="actions" style="display:flex; gap:.5rem; justify-content:flex-end; padding:.75rem 1rem;">
      <button class="btn" id="noteFallbackCancel">Cancel</button>
      <button class="btn btn-primary" id="noteFallbackSave">Save note</button>
    </div>
  </div>
</div>

<!-- Meta fallback -->
<div id="metaFallback" class="modal-fb" aria-hidden="true">
  <div class="panel">
    <header id="metaFallbackTitle"><strong>Meta</strong></header>
    <div class="content">
      <textarea id="metaFallbackText" class="input" rows="6" placeholder='e.g. {"color":"black"}'></textarea>
      <div class="small text-secondary" style="margin-top:.5rem;">Leave blank to clear. JSON is optional.</div>
    </div>
    <div class="actions" style="display:flex; gap:.5rem; justify-content:flex-end; padding:.75rem 1rem;">
      <button class="btn" id="metaFallbackCancel">Cancel</button>
      <button class="btn btn-primary" id="metaFallbackSave">Save meta</button>
    </div>
  </div>
</div>


<!-- Primary Bootstrap Bundle -->
<script id="bs-js-1" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<!-- Secondary Bootstrap Bundles (disabled initially) -->
<script id="bs-js-2" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" defer disabled></script>
<script id="bs-js-3" src="https://unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer disabled></script>

<script>
// ===== Bootstrap load watchdog & fallbacks =====
function bootstrapLoaded() { return !!window.bootstrap; }
function enableAltCDNs(){
  document.getElementById('bs-css-2').disabled = false;
  document.getElementById('bs-css-3').disabled = false;
  document.getElementById('bs-js-2').removeAttribute('disabled');
  document.getElementById('bs-js-3').removeAttribute('disabled');
}
function markFallbackUI(){
  // add .fallback class to body for minimal styles
  document.body.classList.add('fallback');
  // simple navbar toggler fallback
  const toggler = document.querySelector('.navbar-toggler');
  const target = document.getElementById('topNav');
  if(toggler && target){
    toggler.addEventListener('click', ()=>{
      target.style.display = target.style.display === 'block' ? '' : 'block';
    });
  }
}

let bootstrapCheckTries = 0;
function checkBootstrap(){
  if(bootstrapLoaded()) return; // good
  bootstrapCheckTries++;
  if(bootstrapCheckTries === 2){
    // first retry: enable alt CDNs
    enableAltCDNs();
  }
  if(bootstrapCheckTries > 5){
    // give up: offline fallback
    markFallbackUI();
    console.warn('Bootstrap not available; using offline fallback UI.');
    return;
  }
  setTimeout(checkBootstrap, 600);
}
checkBootstrap();
</script>

<script>
// ======= Simple hash router =======
const routes = { "#inventory":"page-inventory", "#statuses":"page-statuses", "#diff":"page-diff" };
function showRoute() {
  const hash = location.hash || "#inventory";
  for (const id of Object.values(routes)) document.getElementById(id).classList.add("vis-hide");
  const pageId = routes[hash] || "page-inventory";
  document.getElementById(pageId).classList.remove("vis-hide");
  document.querySelectorAll(".nav-link").forEach(a => a.classList.toggle("active", a.getAttribute("href") === hash));
}
window.addEventListener("hashchange", showRoute);
window.addEventListener("DOMContentLoaded", showRoute);

// ======= IndexedDB kv =======
const DB_NAME = 'inventoryDB';
const DB_VERSION = 4;
const STORE = 'kv';
const IDB_KEY_ROWS = 'localRows';
const IDB_KEY_STATUS = 'statusOptions';
const LS_KEY_MIGRATION = 'inv.local.rows.v1';

function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath: 'key' });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbGet(key){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, 'readonly');
    const st = tx.objectStore(STORE);
    const req = st.get(key);
    req.onsuccess = ()=> resolve(req.result ? req.result.value : undefined);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbSet(key, value){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, 'readwrite');
    const st = tx.objectStore(STORE);
    const req = st.put({ key, value });
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
  });
}

// ======= Utilities =======
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function norm(v){ return (v ?? '').toString().trim(); }
function toMapById(rows){ const m = new Map(); for(const r of rows){ const id = norm(r.id); if(id) m.set(id, r); } return m; }

function parseCSV(text){
  const rows = []; let i=0, cur='', inQ=false, row=[];
  const pushCell=()=>{ row.push(cur); cur=''; }, pushRow=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const ch=text[i++];
    if(inQ){
      if(ch === '"'){ if(text[i] === '"'){ cur += '"'; i++; } else { inQ=false; } }
      else { cur += ch; }
    } else {
      if(ch === '"'){ inQ=true; }
      else if(ch === ','){ pushCell(); }
      else if(ch === '\r'){}
      else if(ch === '\n'){ pushCell(); pushRow(); }
      else { cur += ch; }
    }
  }
  pushCell(); pushRow();
  if(rows.length && rows[rows.length-1].every(c=>c==='')) rows.pop();
  if(rows.length===0) return {headers:[],rows:[]};
  const headers = rows[0].map(h=>h.trim().replace(/^\ufeff/, ""));
  const outRows = rows.slice(1).map(r => {
    const obj = {}; headers.forEach((h,idx)=> obj[h] = (r[idx] ?? '').trim()); return obj;
  });
  return { headers, rows: outRows };
}

function normalizeCSVText(text){
  if(!text) return text;
  let t = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  while(t.includes("\\n")){
    t = t.replace(/\\n/g, "\n");
  }
  return t;
}
function toCSV(rows){
  const cols = ["Action","Tag","Field","OldValue","NewValue","Notes"];
  const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
  const head = cols.join(",");
  const lines = rows.map(r => cols.map(c => esc(r[c])).join(","));
  return [head,...lines].join("\n");
}
function toMarkdown(rows){
  const cols = ["Action","Tag","Field","OldValue","NewValue","Notes"];
  const head = `| ${cols.join(" | ")} |\n| ${cols.map(()=>"-").join(" | ")} |`;
  const lines = rows.map(r => `| ${cols.map(c => String(r[c] ?? "")).join(" | ")} |`);
  return [head, ...lines].join("\n");
}

// ======= Save Toast (Bootstrap or fallback) =======
const lastSavedEl = document.getElementById('lastSaved');
function updateLastSaved(){
  if(!lastSavedEl) return;
  const ts = new Date();
  const hh = String(ts.getHours()).padStart(2,'0');
  const mm = String(ts.getMinutes()).padStart(2,'0');
  const ss = String(ts.getSeconds()).padStart(2,'0');
  lastSavedEl.textContent = `Last saved at ${hh}:${mm}:${ss}`;
}
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
function setStatus(id, message, variant="info"){
  const el = document.getElementById(id);
  if(!el) return;
  const variants = { info: "text-secondary", success: "text-success", error: "text-danger" };
  el.classList.remove("text-secondary","text-success","text-danger");
  const cls = variants[variant] || variants.info;
  el.classList.add(cls);
  el.textContent = message || "";
}

// ======= Local Working Set =======
const localCols = ["id","serial_number","asset_tag","type","model","room","assigned_to","status","meta"];
const VIEW_MODAL_FIELDS = [
  { label: "ID", aliases: ["id", "ID", "AssetID", "AssetTag", "SerialNumber"] },
  { label: "Name", aliases: ["name", "Name"] },
  { label: "Serial Number", aliases: ["serial_number", "SerialNumber"] },
  { label: "Asset Tag", aliases: ["asset_tag", "AssetTag"] },
  { label: "Status", aliases: ["status", "Status"] },
  { label: "Type", aliases: ["type", "Type"] },
  { label: "Model", aliases: ["model", "Model"] },
  { label: "Device Name", aliases: ["device_name", "DeviceName"] },
  { label: "Assigned To", aliases: ["assigned_to", "AssignedTo"] },
  { label: "Assigned Location", aliases: ["assigned_to_location", "AssignedToLocation"] },
  { label: "Asset Location", aliases: ["asset_location", "AssetLocation", "Location"] },
  { label: "Cubicle / Office / Room", aliases: ["room", "Cubicle/Office/Room", "Cubicle", "Office", "Room"] },
  { label: "Description", aliases: ["description", "Description"] },
  { label: "Managed By", aliases: ["managed_by", "ManagedBy"] },
  { label: "Created By", aliases: ["created_by", "CreatedBy"] },
  { label: "Created Date", aliases: ["created_date", "CreatedDate"] },
  { label: "Modified By", aliases: ["modified_by", "ModifiedBy"] },
  { label: "Modified Date", aliases: ["modified_date", "ModifiedDate"] },
  { label: "Survey Number", aliases: ["survey_number", "SurveyNumber"] },
  { label: "Disposal Reason", aliases: ["disposal_reason", "DisposalReason"] }
];
const tableState = { search:"", status:"", sortBy:"id", sortDir:"asc", page:1, pageSize:"25" };
let pendingRefreshOpts = {};
let refreshTimeout = null;
const SORTABLE_COLS = new Set(localCols.concat("meta"));
function queueTableRefresh(opts){
  pendingRefreshOpts = Object.assign(pendingRefreshOpts, opts || {});
  if(refreshTimeout) return;
  refreshTimeout = setTimeout(()=>{
    const nextOpts = pendingRefreshOpts;
    pendingRefreshOpts = {};
    refreshTimeout = null;
    refreshLocalView(nextOpts);
  }, 40);
}
function normalizeFieldKey(key){
  return (key ?? "").toString().replace(/[^a-z0-9]/gi, "").toLowerCase();
}
function findMatchingKey(src, alias){
  const target = normalizeFieldKey(alias);
  if(!target) return undefined;
  for(const key of Object.keys(src || {})){
    if(normalizeFieldKey(key) === target){
      return key;
    }
  }
  return undefined;
}
function grab(src, ...aliases){
  for(const alias of aliases){
    const match = findMatchingKey(src, alias);
    if(match !== undefined) return src[match];
  }
  return undefined;
}
function upgradeRow(raw){
  const src = raw || {};
  const usedKeys = new Set();
  const take = (...aliases) => {
    for(const alias of aliases){
      const match = findMatchingKey(src, alias);
      if(match !== undefined){
        usedKeys.add(match);
        return src[match];
      }
    }
    return undefined;
  };
  const metaSource = take("meta","metadata","notes");
  const baseMeta = metaSource !== undefined ? parseMeta(metaSource) : {};
  const result = {
    id: norm(take("id","assetid","recordid","tag")),
    serial_number: norm(take("serialnumber","serial","serialno","serial_number")),
    asset_tag: norm(take("assettag","asset_tag","assetnumber","inventorytag")),
    type: norm(take("type","category","devicetype")),
    model: norm(take("model","modelnumber")),
    room: norm(take("cubicleofficeroom","cubicle","office","room","workspace","locationdetail")) || norm(take("location")),
    assigned_to: norm(take("assigned_to","assignedto","assignedperson","holder","assignee","deviceuser")),
    status: norm(take("status","state"))
  };
  const extras = { ...baseMeta };
  for(const [key, value] of Object.entries(src)){
    if(usedKeys.has(key)) continue;
    if(value === undefined || value === null) continue;
    if(typeof value === "string" && value.trim() === "") continue;
    extras[key] = value;
  }
  if(!result.id){
    if(result.asset_tag) result.id = result.asset_tag;
    else if(result.serial_number) result.id = result.serial_number;
  }
  const metaString = Object.keys(extras).length ? JSON.stringify(extras) : "";
  result.meta = metaString;
  return result;
}
function createSeedRows(count=100){
  const types = [
    { type:"Computer", model:"15\" Laptop Pro", name:"Laptop" },
    { type:"Monitor", model:"24\" UltraSharp", name:"Monitor" },
    { type:"Dock", model:"USB-C Dock Gen2", name:"Dock" }
  ];
  const assignedPeople = ["Jamie West","Keith Ross","Taylor Morgan","Alex Rivera","Jordan Blake","Morgan Lee","Sam Patel","Riley Chen","Casey Morgan","Avery Scott"];
  const managers = ["Keith Ross","Morgan Lee","Riley Chen","Avery Scott"];
  const locations = ["Riverside Annex","HQ North","Warehouse B","Innovation Lab","Remote Storage"];
  const rooms = ["Cubicle","Office","Room","Hot Desk","Studio"];
  const statuses = ["Installed","Stored","Returned","Shipped","Initial","Disposed"];
  const descriptions = [
    "Installed last week",
    "Ready for deployment",
    "Awaiting pickup",
    "Returned for diagnostics",
    "Staged for refresh",
    "Decommission scheduled"
  ];
  const createdDates = [
    "Friday, June 20, 2025",
    "Monday, July 1, 2025",
    "Tuesday, July 15, 2025",
    "Wednesday, August 6, 2025"
  ];
  const modifiedDates = [
    "Thursday, June 21, 2025",
    "Tuesday, July 8, 2025",
    "Friday, July 25, 2025",
    "Monday, August 11, 2025"
  ];
  const disposalReasons = ["Obsolete","Damaged","Upgraded","Replaced","Reassigned"];
  const rows = [];
  for(let i=0; i<count; i++){
    const typeInfo = types[i % types.length];
    const assigned = assignedPeople[i % assignedPeople.length];
    const manager = managers[i % managers.length];
    const location = locations[i % locations.length];
    const room = `${rooms[i % rooms.length]} ${((i % 20) + 1)}`;
    const status = statuses[i % statuses.length];
    const description = descriptions[i % descriptions.length];
    const createdDate = createdDates[i % createdDates.length];
    const modifiedDate = modifiedDates[i % modifiedDates.length];
    const surveyNumber = `PSR-${(23 + (i % 3)).toString().padStart(2,'0')}-${(1920 + i).toString().padStart(4,'0')}`;
    const disposalReason = disposalReasons[i % disposalReasons.length];
    const idNumber = 46625 + i;
    const serialNumber = 480000 + i;
    const assetTagNumber = 92800 + i;
    const deviceSuffix = (123200 + i).toString();
    const record = {
      ID: `CI-${idNumber}`,
      Name: `${typeInfo.name}`,
      Model: typeInfo.model,
      Type: typeInfo.type,
      AssetTag: `AT-${assetTagNumber}`,
      SerialNumber: `SN-${serialNumber}`,
      Status: status,
      DeviceName: `${assigned.split(" ").map(w=>w[0]).join("").toUpperCase()}-${deviceSuffix}`,
      AssignedTo: assigned,
      ManagedBy: manager,
      Location: location,
      "Cubicle/Office/Room": room,
      Description: description,
      CreatedBy: manager,
      CreatedDate: createdDate,
      ModifiedBy: assigned,
      ModifiedDate: modifiedDate,
      SurveyNumber: surveyNumber,
      DisposalReason: disposalReason
    };
    rows.push(record);
  }
  return rows;
}
const localBody = $("#localBody"); const selAll = $("#selAll");
const viewModalEl = document.getElementById("viewAssetModal");
const viewModalTitle = document.getElementById("viewAssetModalTitle");
const viewModalDetails = document.getElementById("viewAssetDetails");
const viewModalReadOnly = document.getElementById("viewAssetReadOnly");
const viewModalFormWrap = document.getElementById("viewAssetFormWrap");
const viewModalForm = document.getElementById("viewAssetForm");
const viewModalEditBtn = document.getElementById("viewAssetEdit");
const viewModalCancelBtn = document.getElementById("viewAssetCancelEdit");
const viewModalSaveBtn = document.getElementById("viewAssetSave");
const viewModalStatusSelect = document.getElementById("view_edit_status");
const viewModalStatusCustom = document.getElementById("view_edit_status_custom");
const viewFormInputs = {
  id: document.getElementById("view_edit_id"),
  serial_number: document.getElementById("view_edit_serial_number"),
  asset_tag: document.getElementById("view_edit_asset_tag"),
  type: document.getElementById("view_edit_type"),
  model: document.getElementById("view_edit_model"),
  room: document.getElementById("view_edit_room"),
  assigned_to: document.getElementById("view_edit_assigned_to"),
  meta: document.getElementById("view_edit_meta")
};
let viewModalInstance = null;
let currentViewRow = null;
let viewEditModeActive = false;
if(viewModalEl && window.bootstrap){
  viewModalInstance = new bootstrap.Modal(viewModalEl);
}
function rowToObj(tr){ const tds = Array.from(tr.querySelectorAll("td[data-k]")); const obj = {}; tds.forEach(td => obj[td.dataset.k] = td.textContent.trim()); return obj; }
function objToRow(obj){
  const tr = document.createElement("tr");
  if(obj && obj.id !== undefined) tr.dataset.id = obj.id;
  const tdSel = document.createElement("td"); tdSel.innerHTML = '<input class="form-check-input selRow" type="checkbox">'; tr.appendChild(tdSel);
  for(const k of localCols){
    const td = document.createElement("td");
    td.dataset.k = k;
    const value = k === "meta" ? asMetaText(obj?.meta) : (obj?.[k] ?? "");
    td.textContent = value;
    tr.appendChild(td);
  }
  const tdActions = document.createElement("td");
  tdActions.className = "text-center text-nowrap";
  const viewLink = document.createElement("a");
  viewLink.href = "#";
  viewLink.textContent = "View";
  viewLink.addEventListener("click", ev => {
    ev.preventDefault();
    ev.stopPropagation();
    openViewAsset(tr, { edit: false });
  });
  const separator = document.createTextNode(" | ");
  const editLink = document.createElement("a");
  editLink.href = "#";
  editLink.textContent = "Edit";
  editLink.addEventListener("click", ev => {
    ev.preventDefault();
    ev.stopPropagation();
    openViewAsset(tr, { edit: true });
  });
  tdActions.append(viewLink, separator, editLink);
  tr.appendChild(tdActions);
  return tr;
}
function renderLocal(rows){
  localBody.innerHTML = "";
  (rows || []).map(upgradeRow).forEach(r => localBody.appendChild(objToRow(r)));
  queueTableRefresh({ resetPage:true });
}
function readLocal(){ return Array.from(localBody.querySelectorAll("tr")).map(rowToObj).filter(r => Object.values(r).some(v => v !== "")); }
async function saveLocalToIDB(){
  const rows = readLocal().map(upgradeRow);
  await idbSet('localRows', rows);
}
function addRow(data={}){
  localBody.appendChild(objToRow(upgradeRow(data)));
  queueTableRefresh();
  saveLocalToIDB().then(()=>{
    updateLastSaved();
  });
}
function asMetaText(meta){
  if(meta === undefined || meta === null) return "";
  if(typeof meta === "string") return meta;
  try { return JSON.stringify(meta); } catch { return String(meta); }
}
function parseMeta(metaText){
  const raw = asMetaText(metaText).trim();
  if(!raw) return {};
  try {
    const parsed = JSON.parse(raw);
    if(parsed && typeof parsed === "object") return parsed;
    return { value: parsed };
  } catch {
    return { previousMeta: raw };
  }
}
function toNoteArray(notes){
  if(notes === undefined || notes === null) return [];
  const source = Array.isArray(notes) ? notes : [notes];
  const out = [];
  for(const entry of source){
    if(entry === undefined || entry === null) continue;
    if(typeof entry === "object"){
      const copy = { ...entry };
      if(copy.note !== undefined) copy.note = String(copy.note ?? "");
      out.push(copy);
    } else {
      const text = String(entry);
      if(text.trim() === "") continue;
      out.push({ note: text });
    }
  }
  return out.filter(item => (item.note ?? "").toString().trim() !== "" || item.date !== undefined);
}
function fieldLabel(key){
  return key.split('_').map(part => part ? part[0].toUpperCase() + part.slice(1) : '').join(' ').replace(/Id/g, 'ID');
}
function normalizeViewValue(value){
  if(value === undefined || value === null) return '';
  if(typeof value === 'number'){
    const date = new Date(value);
    if(!Number.isNaN(date.getTime())){
      return date.toLocaleString();
    }
  }
  return String(value ?? '');
}
function formatMetaForView(metaString){
  if(!metaString) return '';
  try {
    const parsed = typeof metaString === 'string' ? JSON.parse(metaString) : metaString;
    return JSON.stringify(parsed, null, 2);
  } catch {
    return String(metaString);
  }
}
function renderViewAsset(row){
  if(!row || !viewModalDetails) return;
  const base = rowToObj(row);
  const extras = parseMeta(base.meta);
  const record = { ...extras, ...base };
  viewModalDetails.innerHTML = '';
  VIEW_MODAL_FIELDS.forEach(field => {
    const value = field.aliases
      .map(alias => record[alias])
      .find(v => v !== undefined && v !== null && String(v).trim() !== '');
    const tr = document.createElement('tr');
    const th = document.createElement('th');
    th.scope = 'row';
    th.textContent = field.label;
    const td = document.createElement('td');
    td.textContent = normalizeViewValue(value ?? '');
    tr.appendChild(th);
    tr.appendChild(td);
    viewModalDetails.appendChild(tr);
  });
  const metaValue = base.meta && base.meta.trim() ? formatMetaForView(base.meta.trim()) : '';
  if(metaValue){
    const tr = document.createElement('tr');
    const th = document.createElement('th');
    th.scope = 'row';
    th.textContent = 'Meta';
    const td = document.createElement('td');
    const pre = document.createElement('pre');
    pre.className = 'mb-0';
    pre.textContent = metaValue;
    td.appendChild(pre);
    tr.appendChild(th);
    tr.appendChild(td);
    viewModalDetails.appendChild(tr);
  }
  if(viewModalTitle){
    const titleId = base.id ? base.id : record.id;
    viewModalTitle.textContent = titleId ? `Asset – ${titleId}` : 'Asset Details';
  }
}
function toggleViewEditMode(enabled){
  viewEditModeActive = !!enabled;
  if(viewModalReadOnly){
    viewModalReadOnly.classList.toggle("d-none", viewEditModeActive);
  }
  if(viewModalFormWrap){
    viewModalFormWrap.classList.toggle("d-none", !viewEditModeActive);
  }
  if(viewModalEditBtn){
    viewModalEditBtn.classList.toggle("d-none", viewEditModeActive);
  }
  if(viewModalCancelBtn){
    viewModalCancelBtn.classList.toggle("d-none", !viewEditModeActive);
  }
  if(viewModalSaveBtn){
    viewModalSaveBtn.classList.toggle("d-none", !viewEditModeActive);
  }
  if(viewEditModeActive && viewFormInputs.id){
    setTimeout(()=> viewFormInputs.id.focus(), 120);
  }
}
function populateViewForm(row){
  if(!row) return;
  const data = rowToObj(row);
  if(viewFormInputs.id) viewFormInputs.id.value = data.id ?? "";
  if(viewFormInputs.serial_number) viewFormInputs.serial_number.value = data.serial_number ?? "";
  if(viewFormInputs.asset_tag) viewFormInputs.asset_tag.value = data.asset_tag ?? "";
  if(viewFormInputs.type) viewFormInputs.type.value = data.type ?? "";
  if(viewFormInputs.model) viewFormInputs.model.value = data.model ?? "";
  if(viewFormInputs.room) viewFormInputs.room.value = data.room ?? "";
  if(viewFormInputs.assigned_to) viewFormInputs.assigned_to.value = data.assigned_to ?? "";
  if(viewFormInputs.meta) viewFormInputs.meta.value = data.meta ?? "";
  const statusValue = data.status ?? "";
  if(viewModalStatusSelect){
    let matched = false;
    Array.from(viewModalStatusSelect.options || []).forEach(opt => {
      if(opt.value === statusValue){
        matched = true;
      }
    });
    viewModalStatusSelect.value = matched ? statusValue : "";
    if(viewModalStatusCustom){
      viewModalStatusCustom.value = matched ? "" : statusValue;
    }
  } else if(viewModalStatusCustom){
    viewModalStatusCustom.value = statusValue;
  }
}
function getFormStatusValue(){
  return norm(viewModalStatusSelect?.value) || norm(viewModalStatusCustom?.value);
}
async function applyViewFormChanges(){
  if(!currentViewRow) return;
  const idInput = viewFormInputs.id;
  const idValue = norm(idInput?.value);
  if(!idValue){
    alert("ID is required.");
    if(idInput) idInput.focus();
    return;
  }
  const updates = {
    id: idValue,
    serial_number: norm(viewFormInputs.serial_number?.value),
    asset_tag: norm(viewFormInputs.asset_tag?.value),
    type: norm(viewFormInputs.type?.value),
    model: norm(viewFormInputs.model?.value),
    room: norm(viewFormInputs.room?.value),
    assigned_to: norm(viewFormInputs.assigned_to?.value),
    status: getFormStatusValue(),
    meta: viewFormInputs.meta?.value?.trim() ?? ""
  };
  for(const key of localCols){
    const cell = currentViewRow.querySelector(`td[data-k="${key}"]`);
    if(!cell) continue;
    if(key === "meta"){
      cell.textContent = updates.meta;
    } else if(key === "status"){
      cell.textContent = updates.status;
    } else {
      cell.textContent = updates[key] ?? "";
    }
  }
  currentViewRow.dataset.id = updates.id;
  updateMetaButtonState(currentViewRow);
  updateNoteButtonState(currentViewRow);
  renderViewAsset(currentViewRow);
  populateViewForm(currentViewRow);
  queueTableRefresh();
  if(viewModalSaveBtn) viewModalSaveBtn.disabled = true;
  try {
    await saveLocalToIDB();
    showSavedToast();
    updateLastSaved();
    setStatus("localImportStatus", `Asset ${updates.id} updated.`, "success");
    toggleViewEditMode(false);
  } catch(err){
    setStatus("localImportStatus", `Failed to save changes: ${err.message}`, "error");
  } finally {
    if(viewModalSaveBtn) viewModalSaveBtn.disabled = false;
  }
}
function resetViewModalState(){
  currentViewRow = null;
  toggleViewEditMode(false);
}
function openViewAsset(row, options){
  if(!row) return;
  const { edit = false } = options || {};
  if(!viewModalEl || !viewModalDetails){
    alert('Asset details modal is unavailable in this environment.');
    return;
  }
  currentViewRow = row;
  renderViewAsset(row);
  populateViewForm(row);
  toggleViewEditMode(!!edit);
  if(viewModalInstance){
    viewModalInstance.show();
  } else {
    viewModalEl.classList.add('show');
    viewModalEl.style.display = 'block';
  }
}
if(viewModalEl && !viewModalInstance){
  const closeButton = viewModalEl.querySelector('[data-bs-dismiss="modal"]');
  closeButton?.addEventListener('click', ()=>{
    viewModalEl.classList.remove('show');
    viewModalEl.style.display = 'none';
    resetViewModalState();
  });
  viewModalEl.addEventListener('click', ev => {
    if(ev.target === viewModalEl){
      viewModalEl.classList.remove('show');
      viewModalEl.style.display = 'none';
      resetViewModalState();
    }
  });
}
if(viewModalEl && viewModalInstance){
  viewModalEl.addEventListener('hidden.bs.modal', resetViewModalState);
}
if(viewModalEditBtn){
  viewModalEditBtn.addEventListener("click", ()=>{
    if(!currentViewRow) return;
    populateViewForm(currentViewRow);
    toggleViewEditMode(true);
  });
}
if(viewModalCancelBtn){
  viewModalCancelBtn.addEventListener("click", ()=>{
    if(currentViewRow) populateViewForm(currentViewRow);
    toggleViewEditMode(false);
  });
}
if(viewModalForm){
  viewModalForm.addEventListener("submit", ev => {
    ev.preventDefault();
    applyViewFormChanges();
  });
}
if(viewModalStatusSelect){
  viewModalStatusSelect.addEventListener("change", ()=>{
    if(viewModalStatusCustom && viewModalStatusSelect.value){
      viewModalStatusCustom.value = "";
    }
  });
}
if(viewModalStatusCustom){
  viewModalStatusCustom.addEventListener("input", ()=>{
    if(viewModalStatusSelect && viewModalStatusCustom.value.trim().length){
      viewModalStatusSelect.value = "";
    }
  });
}
function formatNoteTimestamp(value){
  if(value === undefined || value === null || value === ""){
    return "No date provided";
  }
  let date = new Date(value);
  if(Number.isNaN(date.getTime())){
    const num = Number(value);
    if(!Number.isNaN(num)){
      date = new Date(num);
    }
  }
  if(Number.isNaN(date.getTime())){
    return String(value);
  }
  return date.toLocaleString();
}
function updateNoteButtonState(tr){
  const metaCell = tr.querySelector('td[data-k="meta"]');
  const viewBtn = tr.querySelector(".view-note-btn");
  if(!metaCell || !viewBtn) return;
  const notes = toNoteArray(parseMeta(metaCell.textContent).notes);
  const count = notes.length;
  viewBtn.textContent = count ? `Notes (${count})` : "Notes";
  viewBtn.classList.toggle("btn-secondary", count > 0);
  viewBtn.classList.toggle("btn-outline-secondary", count === 0);
  viewBtn.title = count ? `${count} note${count===1?"":"s"}` : "No notes yet";
}
function updateMetaButtonState(tr){
  const metaCell = tr.querySelector('td[data-k="meta"]');
  const metaBtn = tr.querySelector(".view-meta-btn");
  if(!metaCell || !metaBtn) return;
  const hasMeta = metaCell.textContent.trim().length > 0;
  metaBtn.classList.toggle("btn-secondary", hasMeta);
  metaBtn.classList.toggle("btn-outline-secondary", !hasMeta);
  metaBtn.textContent = hasMeta ? "Meta •" : "Meta";
  metaBtn.title = hasMeta ? metaCell.textContent : "No meta stored";
}
let currentNoteRow = null;
let currentMetaRow = null;
function handleAddNote(tr){
  currentNoteRow = tr;
  const idCell = tr.querySelector('td[data-k="id"]');
  const assetId = idCell?.textContent.trim() || "(no id)";
  if(window.bootstrap && noteModalEl){
    if(noteModalTitle) noteModalTitle.textContent = `Add Note – ${assetId}`;
    if(noteTextEl) noteTextEl.value = "";
    const modal = bootstrap.Modal.getOrCreateInstance(noteModalEl);
    modal.show();
    setTimeout(()=> noteTextEl?.focus(), 120);
  } else if(noteFallbackEl){
    if(noteFallbackTitle) noteFallbackTitle.innerHTML = `<strong>Add Note – ${escapeHtml(assetId)}</strong>`;
    if(noteFallbackText) noteFallbackText.value = "";
    noteFallbackEl.classList.add('show');
    setTimeout(()=> noteFallbackText?.focus(), 50);
  } else {
    setStatus("localImportStatus", "Note entry UI unavailable in this environment.", "error");
  }
}
function commitNote(noteTextRaw){
  const tr = currentNoteRow;
  if(!tr){
    setStatus("localImportStatus", "No row selected for note.", "error");
    return false;
  }
  const noteText = noteTextRaw.trim();
  if(noteText === ""){
    setStatus("localImportStatus", "Empty note discarded.", "info");
    return false;
  }
  const metaCell = tr.querySelector('td[data-k="meta"]');
  if(!metaCell){
    setStatus("localImportStatus", "Unable to locate meta field for this row.", "error");
    return false;
  }
  const metaObj = parseMeta(metaCell.textContent);
  const entry = { date: Date.now(), note: noteText };
  if(metaObj.notes === undefined){
    metaObj.notes = entry;
  } else if(Array.isArray(metaObj.notes)){
    metaObj.notes.push(entry);
  } else {
    metaObj.notes = [metaObj.notes, entry];
  }
  metaCell.textContent = JSON.stringify(metaObj);
  updateNoteButtonState(tr);
  updateMetaButtonState(tr);
  saveLocalToIDB().then(()=>{
    showSavedToast();
    const ts = new Date(entry.date).toLocaleString();
    setStatus("localImportStatus", `Note added (${ts}).`, "success");
    queueTableRefresh();
    currentNoteRow = null;
  }).catch(err=>{
    setStatus("localImportStatus", `Failed to save note: ${err.message}`, "error");
  });
  return true;
}
function handleViewMeta(tr){
  currentMetaRow = tr;
  const idCell = tr.querySelector('td[data-k="id"]');
  const metaCell = tr.querySelector('td[data-k="meta"]');
  if(!metaCell){
    setStatus("localImportStatus", "Unable to locate meta field for this row.", "error");
    return;
  }
  const assetId = idCell?.textContent.trim() || "(no id)";
  const rawMeta = metaCell.textContent ?? "";
  const prettyMeta = (()=>{
    if(!rawMeta) return "";
    try { return JSON.stringify(JSON.parse(rawMeta), null, 2); }
    catch { return rawMeta; }
  })();
  if(window.bootstrap && metaModalEl){
    if(metaModalTitle) metaModalTitle.textContent = `Meta – ${assetId}`;
    if(metaModalText) metaModalText.value = prettyMeta;
    const modal = bootstrap.Modal.getOrCreateInstance(metaModalEl);
    modal.show();
    setTimeout(()=> metaModalText?.focus(), 120);
  } else if(metaFallbackEl){
    if(metaFallbackTitle) metaFallbackTitle.innerHTML = `<strong>Meta – ${escapeHtml(assetId)}</strong>`;
    if(metaFallbackText) metaFallbackText.value = prettyMeta;
    metaFallbackEl.classList.add('show');
    setTimeout(()=> metaFallbackText?.focus(), 50);
  } else {
    setStatus("localImportStatus", "Meta viewer unavailable in this environment.", "error");
  }
}
function commitMetaValue(valueRaw){
  const tr = currentMetaRow;
  if(!tr){
    setStatus("localImportStatus", "No row selected for meta.", "error");
    return false;
  }
  const metaCell = tr.querySelector('td[data-k="meta"]');
  if(!metaCell){
    setStatus("localImportStatus", "Unable to locate meta field for this row.", "error");
    return false;
  }
  const metaValue = typeof valueRaw === "string" ? valueRaw.trim() : "";
  metaCell.textContent = metaValue;
  updateMetaButtonState(tr);
  updateNoteButtonState(tr);
  queueTableRefresh();
  saveLocalToIDB().then(()=>{
    showSavedToast();
    const message = metaValue ? "Meta updated." : "Meta cleared.";
    setStatus("localImportStatus", message, "success");
    currentMetaRow = null;
  }).catch(err=>{
    setStatus("localImportStatus", `Failed to save meta: ${err.message}`, "error");
  });
  return true;
}
function handleViewNotes(tr){
  const idCell = tr.querySelector('td[data-k="id"]');
  const metaCell = tr.querySelector('td[data-k="meta"]');
  if(!metaCell){
    setStatus("localImportStatus", "Unable to locate meta field for this row.", "error");
    return;
  }
  const assetId = idCell?.textContent.trim() || "(no id)";
  const rawMeta = metaCell.textContent ?? "";
  const parsedMeta = parseMeta(rawMeta);
  const notes = toNoteArray(parsedMeta.notes);
  const listHtml = notes.length
    ? `<ol class="mb-0">${notes.map(entry=>{
        const timestamp = formatNoteTimestamp(entry.date);
        const noteText = (entry.note ?? "").toString();
        const formattedNote = noteText
          ? escapeHtml(noteText).replace(/\n/g,"<br>")
          : '<span class="text-secondary fst-italic">No note text</span>';
        const extrasKeys = Object.keys(entry).filter(k => k !== "note" && k !== "date");
        const extras = extrasKeys.length
          ? `<div class="small text-secondary">${extrasKeys.map(k => `${escapeHtml(k)}: ${escapeHtml(String(entry[k]))}`).join(", ")}</div>`
          : "";
        return `<li><time>${escapeHtml(timestamp)}</time><div>${formattedNote}</div>${extras}</li>`;
      }).join("")}</ol>`
    : '<p class="text-secondary mb-0">No notes recorded yet.</p>';
  let prettyMeta = rawMeta.trim();
  if(prettyMeta){
    try {
      prettyMeta = JSON.stringify(JSON.parse(rawMeta), null, 2);
    } catch {}
  } else {
    prettyMeta = "(empty)";
  }
  if(window.bootstrap && notesModalEl){
    notesTitleEl.textContent = `Notes – ${assetId}`;
    notesListEl.innerHTML = listHtml;
    notesMetaEl.textContent = prettyMeta;
    const modal = bootstrap.Modal.getOrCreateInstance(notesModalEl);
    modal.show();
  } else if(notesFallbackEl){
    notesFallbackTitle.innerHTML = `<strong>Notes – ${escapeHtml(assetId)}</strong>`;
    notesFallbackContent.innerHTML = `${listHtml}<hr><div class="small text-secondary mb-1">Meta JSON</div><pre class="notes-pre">${escapeHtml(prettyMeta)}</pre>`;
    notesFallbackEl.classList.add('show');
  } else {
    setStatus("localImportStatus", "Unable to display notes viewer.", "error");
  }
}
function normalizeSearchValue(value){
  return (value ?? "").toString().toLowerCase();
}
function compareValues(a, b, key){
  const vaRaw = a[key] ?? "";
  const vbRaw = b[key] ?? "";
  const vaStr = (vaRaw ?? "").toString().trim();
  const vbStr = (vbRaw ?? "").toString().trim();
  const na = Number(vaStr);
  const nb = Number(vbStr);
  const bothNumeric = !Number.isNaN(na) && !Number.isNaN(nb);
  if(bothNumeric){
    if(na < nb) return -1;
    if(na > nb) return 1;
    return 0;
  }
  return vaStr.localeCompare(vbStr, undefined, { sensitivity:"base", numeric:true });
}
function updateSortIndicators(){
  const ths = document.querySelectorAll('#localTable thead th[data-sort]');
  ths.forEach(th => {
    const key = th.dataset.sort;
    const indicator = th.querySelector('.sort-indicator');
    const isActive = key === tableState.sortBy;
    th.classList.toggle('sorted', isActive);
    const dir = isActive ? tableState.sortDir : "none";
    th.setAttribute("aria-sort", dir === "none" ? "none" : (dir === "asc" ? "ascending" : "descending"));
    if(indicator){
      let symbol = "↕";
      if(isActive){
        symbol = tableState.sortDir === "asc" ? "▲" : "▼";
      }
      indicator.textContent = symbol;
    }
  });
}
function updateStatusFilterOptions(source){
  if(!localStatusFilter) return;
  const arr = Array.isArray(source) ? source : [];
  const deduped = Array.from(new Set(arr.filter(Boolean).map(v => v.toString())));
  const current = localStatusFilter.value;
  const options = ['<option value="">All statuses</option>', ...deduped.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"})).map(val => `<option value="${escapeHtml(val)}">${escapeHtml(val)}</option>`)];
  localStatusFilter.innerHTML = options.join("");
  if(deduped.includes(current)){
    localStatusFilter.value = current;
  } else {
    localStatusFilter.value = "";
    tableState.status = "";
  }
}
function syncStatusFilterOptions(){
  if(!localStatusFilter) return;
  const rows = Array.from(localBody.querySelectorAll("tr"));
  const statuses = new Set();
  rows.forEach(row => {
    const obj = rowToObj(row);
    if(obj.status) statuses.add(obj.status);
  });
  updateStatusFilterOptions(Array.from(statuses));
}
function refreshLocalView(opts){
  opts = opts || {};
  if(opts.resetPage){ tableState.page = 1; }
  if(opts.search !== undefined){ tableState.search = opts.search; }
  if(opts.status !== undefined){ tableState.status = opts.status; }
  if(opts.pageSize !== undefined){ tableState.pageSize = opts.pageSize; }
  if(opts.sortBy !== undefined && SORTABLE_COLS.has(opts.sortBy)){
    if(tableState.sortBy !== opts.sortBy){
      tableState.sortBy = opts.sortBy;
    }
  }
  if(opts.sortDir !== undefined){
    tableState.sortDir = opts.sortDir === "desc" ? "desc" : "asc";
  }
  if(opts.page !== undefined){
    tableState.page = Math.max(1, Number(opts.page) || 1);
  }
  const rows = Array.from(localBody.querySelectorAll("tr"));
  syncStatusFilterOptions();
  const searchTerm = normalizeSearchValue(tableState.search).trim();
  const statusFilterValue = tableState.status;
  const filtered = [];
  rows.forEach(row => {
    const data = rowToObj(row);
    const values = Object.values(data).map(v => normalizeSearchValue(v));
    const matchesSearch = searchTerm ? values.some(val => val.includes(searchTerm)) : true;
    const matchesStatus = statusFilterValue ? normalizeSearchValue(data.status) === normalizeSearchValue(statusFilterValue) : true;
    if(matchesSearch && matchesStatus){
      filtered.push({ row, data });
    } else {
      row.style.display = "none";
    }
  });
  const sortKey = SORTABLE_COLS.has(tableState.sortBy) ? tableState.sortBy : "id";
  filtered.sort((a,b)=>{
    const cmp = compareValues(a.data, b.data, sortKey);
    return tableState.sortDir === "desc" ? -cmp : cmp;
  });
  filtered.forEach(item => localBody.appendChild(item.row));
  const totalRows = rows.length;
  const totalFiltered = filtered.length;
  const pageSizeRaw = tableState.pageSize;
  const pageSize = pageSizeRaw === "all" ? 0 : Math.max(1, Number(pageSizeRaw) || 25);
  const totalPages = pageSize === 0 ? 1 : Math.max(1, Math.ceil(totalFiltered / pageSize));
  tableState.page = Math.min(Math.max(1, tableState.page), totalPages);
  const startIndex = pageSize === 0 ? 0 : (tableState.page - 1) * pageSize;
  const endIndex = pageSize === 0 ? totalFiltered : Math.min(startIndex + pageSize, totalFiltered);
  filtered.forEach((item, idx)=>{
    const visible = pageSize === 0 || (idx >= startIndex && idx < endIndex);
    item.row.style.display = visible ? "" : "none";
  });
  if(localFilterStatus){
    if(totalFiltered === 0){
      localFilterStatus.textContent = totalRows === 0
        ? "No rows in the working set yet."
        : "No rows match your current filters.";
    } else {
      const displayStart = pageSize === 0 ? 1 : startIndex + 1;
      const displayEnd = pageSize === 0 ? totalFiltered : endIndex;
      const info = `${displayStart}–${displayEnd} of ${totalFiltered} matching row${totalFiltered===1?"":"s"} (${totalRows} total)`;
      localFilterStatus.textContent = info;
    }
  }
  const prevDisabled = tableState.page <= 1;
  const nextDisabled = tableState.page >= totalPages;
  if(localPrevPage){ localPrevPage.disabled = prevDisabled; }
  if(localNextPage){ localNextPage.disabled = nextDisabled; }
  if(localPaginationInfo){
    if(totalFiltered === 0){
      localPaginationInfo.textContent = "";
    } else if(pageSize === 0){
      localPaginationInfo.textContent = `Showing all ${totalFiltered} row${totalFiltered===1?"":"s"}.`;
    } else {
      localPaginationInfo.textContent = `Page ${tableState.page} of ${totalPages}`;
    }
  }
  if(localPaginationBar){
    const hidePagination = totalFiltered <= (pageSize === 0 ? Infinity : pageSize);
    localPaginationBar.classList.toggle("vis-hide", hidePagination);
  }
  updateSortIndicators();
}
function deleteSelected(){
  $$(".selRow:checked").forEach(cb => cb.closest("tr").remove());
  queueTableRefresh();
  saveLocalToIDB().then(()=>{ updateLastSaved(); });
}
function clearAll(){
  localBody.innerHTML = "";
  queueTableRefresh({ resetPage:true });
  saveLocalToIDB().then(()=>{ updateLastSaved(); });
}
selAll.addEventListener("change", e => { $$(".selRow").forEach(cb => cb.checked = selAll.checked); });

// ======= Status options =======
const statusInput = $("#statusOptions"); const statusSaved = $("#statusSaved");
$("#saveStatus").addEventListener("click", async ()=>{
  const raw = statusInput.value; const arr = raw.split(",").map(s => s.trim()).filter(Boolean);
  await idbSet(IDB_KEY_STATUS, arr); statusSaved.textContent = `Saved ${arr.length} item(s)`; populateStatusSelect(arr); showSavedToast();
});
function populateStatusSelect(arr){
  const list = Array.isArray(arr) ? arr : [];
  const applyOptions = (selectEl)=>{
    if(!selectEl) return;
    selectEl.innerHTML = "";
    const blankOpt = document.createElement("option");
    blankOpt.value = "";
    blankOpt.textContent = "(none)";
    selectEl.appendChild(blankOpt);
    for(const s of list){
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      selectEl.appendChild(opt);
    }
  };
  applyOptions(document.getElementById("m_status"));
  applyOptions(viewModalStatusSelect);
  const fbSel = document.getElementById("fb_status");
  if(fbSel){
    const options = ['<option value="">(none)</option>', ...list.map(s => `<option>${escapeHtml(s)}</option>`)];
    fbSel.innerHTML = options.join("");
  }
  updateStatusFilterOptions(list);
  queueTableRefresh();
  if(currentViewRow){
    populateViewForm(currentViewRow);
  }
}

// ======= Official snapshot =======
let officialRows = []; const officialStats = $("#officialStats");
const officialPreviewWrap = $("#officialPreviewWrap"); const officialPreviewHead = $("#officialPreview thead"); const officialPreviewBody = $("#officialPreview tbody");
function loadOfficialCSVObjects(rows, opts){
  officialRows = rows;
  const statsLabel = opts?.statsLabel ?? `${rows.length} row(s) ready`;
  officialStats.textContent = statsLabel;
  officialPreviewHead.innerHTML = "";
  officialPreviewBody.innerHTML = "";
  officialPreviewWrap.textContent = "";
  officialPreviewWrap.classList.add("vis-hide");
}
function clearOfficial(){
  officialRows = [];
  officialStats.textContent = "No file loaded";
  officialPreviewWrap.classList.add("vis-hide");
  officialPreviewHead.innerHTML="";
  officialPreviewBody.innerHTML="";
  setStatus("officialImportStatus", "Official snapshot cleared.", "info");
}

// ======= Diff logic =======
function diffInventories(localRows, officialRows, opts){
  const { emptyClears=false, ignoreMeta=false } = opts || {};
  const baseFields = ["serial_number","asset_tag","type","model","room","assigned_to","status","meta"];
  const fields = baseFields.filter(f => !(ignoreMeta && f==="meta"));
  const local = toMapById(localRows); const official = toMapById(officialRows);
  const tags = new Set([...local.keys(), ...official.keys()]); const changes = [];
  for(const id of tags){
    const L = local.get(id); const O = official.get(id);
    if(L && !O){ changes.push({Action:"ADD", Tag:id, Field:"(all)", OldValue:"", NewValue:JSON.stringify(L), Notes:""}); continue; }
    if(!L && O){ changes.push({Action:"REMOVE", Tag:id, Field:"(all)", OldValue:JSON.stringify(O), NewValue:"", Notes:"Not in local working set"}); continue; }
    for(const f of fields){
      const o = norm(O?.[f]); const l = norm(L?.[f]); const isEmptyNoOp = !emptyClears && l === ""; const changed = isEmptyNoOp ? false : (o !== l);
      if(changed){ changes.push({Action:"UPDATE", Tag:id, Field:f, OldValue:o, NewValue:l, Notes:""}); }
    }
  }
  return changes;
}
function renderDiff(rows){
  const tbody = $("#diffBody"); tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.Action}</td><td class="code">${r.Tag}</td><td>${r.Field}</td>
      <td class="code">${escapeHtml(r.OldValue)}</td>
      <td class="code">${escapeHtml(r.NewValue)}</td><td>${r.Notes??""}</td>`;
    tbody.appendChild(tr);
  }
  $("#diffStats").textContent = rows.length ? `${rows.length} change(s)` : "No differences";
  $("#downloadCsv").disabled = rows.length===0; $("#copyMd").disabled = rows.length===0;
}
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

// ======= Wire up =======
$("#deleteSelected").addEventListener("click", deleteSelected);
$("#clearAll").addEventListener("click", clearAll);

$("#saveLocalJson").addEventListener("click", ()=>{
  const rows = readLocal().map(upgradeRow); const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([JSON.stringify(rows, null, 2)], {type:"application/json"}));
  a.download = "local-working-set.json"; a.click();
});
$("#saveLocalCsv").addEventListener("click", ()=>{
  const rows = readLocal().map(upgradeRow); const cols = localCols; const head = cols.join(",");
  const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
  const lines = rows.map(r => cols.map(c => esc(r[c])).join(","));
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([[head, ...lines].join("\n")], {type:"text/csv"}));
  a.download = "local-working-set.csv"; a.click();
});

$("#loadLocalFile").addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f){ setStatus("localImportStatus", "No file selected.", "info"); return; }
  setStatus("localImportStatus", `Reading "${f.name}"…`, "info");
  try{
    let text = await f.text();
    text = normalizeCSVText(text);
    let rows;
    if(f.name.toLowerCase().endsWith(".json")){
      rows = JSON.parse(text);
      if(!Array.isArray(rows)){
        const candidate = grab(rows || {}, "rows","data","items","inventory","Records","records");
        if(Array.isArray(candidate)){ rows = candidate; }
        else throw new Error("JSON must be an array or contain a top-level array (rows/items/data).");
      }
    } else {
      const parsed = parseCSV(text);
      rows = parsed.rows;
      if(rows.length === 0){ throw new Error("No data rows detected in CSV."); }
    }
    const total = rows.length;
    const upgraded = rows.map(upgradeRow);
    const valid = upgraded.filter(r => norm(r.id));
    const skipped = total - valid.length;
    renderLocal(valid);
    await saveLocalToIDB();
    if(valid.length === 0){
      setStatus("localImportStatus", "Import completed but no rows contained an \"id\" value.", "info");
    } else {
      const msg = [`Imported ${valid.length} row${valid.length===1?"":"s"}`];
      if(skipped > 0){ msg.push(`${skipped} skipped (missing id)`); }
      setStatus("localImportStatus", msg.join("; ") + ".", "success");
    }
  } catch(err){
    setStatus("localImportStatus", `Import failed: ${err.message}`, "error");
  } finally {
    e.target.value = "";
  }
});

$("#loadOfficialCsv").addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f){ setStatus("officialImportStatus", "No file selected.", "info"); return; }
  setStatus("officialImportStatus", `Reading "${f.name}"…`, "info");
  try{
    let text = await f.text();
    text = normalizeCSVText(text);
    const { headers, rows } = parseCSV(text);
    if(headers.length===0) throw new Error("No headers found");
    const canonical = rows.map(r => {
      const o = {};
      for(const k of Object.keys(r)){
        const key = typeof k === "string" ? k.trim() : k;
        if(key) o[key] = r[k];
      }
      return o;
    });
    const upgraded = canonical.map(upgradeRow);
    const total = upgraded.length;
    if(total === 0){
      loadOfficialCSVObjects([], { statsLabel: "0 row(s) ready" });
      setStatus("officialImportStatus", "Import completed but the file contained no data rows.", "info");
      return;
    }
    const valid = upgraded.filter(r => norm(r.id));
    const skipped = total - valid.length;
    if(valid.length === 0){
      loadOfficialCSVObjects([], { statsLabel: "0 row(s) ready" });
      setStatus("officialImportStatus", "No rows contained an identifier (id/tag); nothing was loaded.", "error");
      return;
    }
    const statsLabel = `${valid.length} row${valid.length===1?"":"s"} ready${skipped>0?`, ${skipped} skipped`:""}`;
    loadOfficialCSVObjects(valid, { statsLabel });
    const msg = [`Loaded ${valid.length} row${valid.length===1?"":"s"} from "${f.name}"`];
    if(skipped > 0) msg.push(`${skipped} skipped (missing id)`);
    setStatus("officialImportStatus", msg.join("; ") + ".", skipped > 0 ? "info" : "success");
  } catch(err){
    setStatus("officialImportStatus", `Import failed: ${err.message}`, "error");
  } finally {
    e.target.value = "";
  }
});

$("#btnDiff").addEventListener("click", async ()=>{
  const local = readLocal().map(upgradeRow); if(local.some(r => !norm(r.id))) { alert("All rows must have a non-empty 'id'."); return; }
  const opts = { emptyClears: $("#emptyClears").checked, ignoreMeta: $("#ignoreMeta").checked };
  const diff = diffInventories(local, officialRows, opts); renderDiff(diff); window.__lastDiff = diff;
});
$("#downloadCsv").addEventListener("click", ()=>{
  const diff = window.__lastDiff || []; const csv = toCSV(diff);
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"})); a.download = `inventory-changes-${ts}.csv`; a.click();
});
$("#copyMd").addEventListener("click", async ()=>{
  const diff = window.__lastDiff || []; const md = toMarkdown(diff);
  try { await navigator.clipboard.writeText(md); alert("Markdown copied to clipboard."); } catch { alert("Copy failed—your browser may block clipboard access."); }
});

// ======= Add Modal (Bootstrap or fallback) =======
const openAdd = document.getElementById('openAdd');
const confirmAdd = document.getElementById('confirmAdd');
const addModalEl = document.getElementById('addModal');
const fbModalEl = document.getElementById('fallbackModal');

const m_id = document.getElementById('m_id');
const m_serial_number = document.getElementById('m_serial_number');
const m_asset_tag = document.getElementById('m_asset_tag');
const m_type = document.getElementById('m_type');
const m_model = document.getElementById('m_model');
const m_room = document.getElementById('m_room');
const m_assigned_to = document.getElementById('m_assigned_to');
const m_status = document.getElementById('m_status');
const m_status_custom = document.getElementById('m_status_custom');
const m_meta = document.getElementById('m_meta');

const fb_id = document.getElementById('fb_id');
const fb_serial_number = document.getElementById('fb_serial_number');
const fb_asset_tag = document.getElementById('fb_asset_tag');
const fb_type = document.getElementById('fb_type');
const fb_model = document.getElementById('fb_model');
const fb_room = document.getElementById('fb_room');
const fb_assigned_to = document.getElementById('fb_assigned_to');
const fb_status = document.getElementById('fb_status');
const fb_status_custom = document.getElementById('fb_status_custom');
const fb_meta = document.getElementById('fb_meta');
const fb_cancel = document.getElementById('fb_cancel');
const fb_confirm = document.getElementById('fb_confirm');
const localSearchInput = document.getElementById('localSearch');
const localStatusFilter = document.getElementById('localStatusFilter');
const localPageSizeSelect = document.getElementById('localPageSize');
const localFilterStatus = document.getElementById('localFilterStatus');
const localPaginationInfo = document.getElementById('localPaginationInfo');
const localPaginationBar = document.getElementById('localPaginationBar');
const localPrevPage = document.getElementById('localPrevPage');
const localNextPage = document.getElementById('localNextPage');
const notesModalEl = document.getElementById('notesModal');
const notesTitleEl = document.getElementById('notesTitle');
const notesListEl = document.getElementById('notesList');
const notesMetaEl = document.getElementById('notesMetaJson');
const noteModalEl = document.getElementById('noteModal');
const noteModalTitle = document.getElementById('noteModalTitle');
const noteTextEl = document.getElementById('noteText');
const noteModalSaveBtn = document.getElementById('noteModalSave');
const metaModalEl = document.getElementById('metaModal');
const metaModalTitle = document.getElementById('metaModalTitle');
const metaModalText = document.getElementById('metaModalText');
const metaModalSaveBtn = document.getElementById('metaModalSave');
const notesFallbackEl = document.getElementById('notesFallback');
const notesFallbackTitle = document.getElementById('notesFallbackTitle');
const notesFallbackContent = document.getElementById('notesFallbackContent');
const notesFallbackClose = document.getElementById('notesFallbackClose');
const noteFallbackEl = document.getElementById('noteFallback');
const noteFallbackTitle = document.getElementById('noteFallbackTitle');
const noteFallbackText = document.getElementById('noteFallbackText');
const noteFallbackCancel = document.getElementById('noteFallbackCancel');
const noteFallbackSave = document.getElementById('noteFallbackSave');
const metaFallbackEl = document.getElementById('metaFallback');
const metaFallbackTitle = document.getElementById('metaFallbackTitle');
const metaFallbackText = document.getElementById('metaFallbackText');
const metaFallbackCancel = document.getElementById('metaFallbackCancel');
const metaFallbackSave = document.getElementById('metaFallbackSave');
const seedSampleBtn = document.getElementById('seedSample');

if(noteModalSaveBtn && noteModalEl){
  noteModalSaveBtn.addEventListener("click", ()=>{
    if(commitNote(noteTextEl.value)){
      if(window.bootstrap){
        const inst = bootstrap.Modal.getInstance(noteModalEl);
        inst?.hide();
      }
      if(noteTextEl) noteTextEl.value = "";
    }
  });
  noteModalEl.addEventListener("shown.bs.modal", ()=> noteTextEl?.focus());
  noteModalEl.addEventListener("hidden.bs.modal", ()=>{
    currentNoteRow = null;
    if(noteTextEl) noteTextEl.value = "";
  });
}
if(metaModalSaveBtn && metaModalEl){
  metaModalSaveBtn.addEventListener("click", ()=>{
    if(commitMetaValue(metaModalText.value)){
      if(window.bootstrap){
        const inst = bootstrap.Modal.getInstance(metaModalEl);
        inst?.hide();
      }
      if(metaModalText) metaModalText.value = "";
    }
  });
  metaModalEl.addEventListener("shown.bs.modal", ()=> metaModalText?.focus());
  metaModalEl.addEventListener("hidden.bs.modal", ()=>{
    currentMetaRow = null;
    if(metaModalText) metaModalText.value = "";
  });
}
if(noteFallbackCancel && noteFallbackEl){
  noteFallbackCancel.addEventListener("click", ()=>{
    noteFallbackEl.classList.remove('show');
    currentNoteRow = null;
    if(noteFallbackText) noteFallbackText.value = "";
  });
}
if(noteFallbackSave && noteFallbackEl){
  noteFallbackSave.addEventListener("click", ()=>{
    if(commitNote(noteFallbackText.value)){
      noteFallbackEl.classList.remove('show');
      currentNoteRow = null;
      if(noteFallbackText) noteFallbackText.value = "";
    }
  });
}
if(noteFallbackEl){
  noteFallbackEl.addEventListener("click", ev => {
    if(ev.target === noteFallbackEl){
      noteFallbackEl.classList.remove('show');
      currentNoteRow = null;
      if(noteFallbackText) noteFallbackText.value = "";
    }
  });
}
if(metaFallbackCancel && metaFallbackEl){
  metaFallbackCancel.addEventListener("click", ()=>{
    metaFallbackEl.classList.remove('show');
    currentMetaRow = null;
    if(metaFallbackText) metaFallbackText.value = "";
  });
}
if(metaFallbackSave && metaFallbackEl){
  metaFallbackSave.addEventListener("click", ()=>{
    if(commitMetaValue(metaFallbackText.value)){
      metaFallbackEl.classList.remove('show');
      currentMetaRow = null;
      if(metaFallbackText) metaFallbackText.value = "";
    }
  });
}
if(metaFallbackEl){
  metaFallbackEl.addEventListener("click", ev => {
    if(ev.target === metaFallbackEl){
      metaFallbackEl.classList.remove('show');
      currentMetaRow = null;
      if(metaFallbackText) metaFallbackText.value = "";
    }
  });
}
if(seedSampleBtn){
  seedSampleBtn.addEventListener("click", async ()=>{
    if(!confirm("Replace current inventory with sample data?")) return;
    const sampleRows = createSeedRows(100).map(upgradeRow);
    renderLocal(sampleRows);
    await idbSet(IDB_KEY_ROWS, sampleRows);
    queueTableRefresh({ resetPage:true });
    showSavedToast();
    setStatus("localImportStatus", "Sample data populated.", "success");
  });
}
if(notesFallbackClose && notesFallbackEl){
  notesFallbackClose.addEventListener("click", ()=> notesFallbackEl.classList.remove('show'));
}
if(notesFallbackEl){
  notesFallbackEl.addEventListener("click", ev => {
    if(ev.target === notesFallbackEl){
      notesFallbackEl.classList.remove('show');
    }
  });
}
if(localSearchInput){
  const onSearchChange = debounce(value => queueTableRefresh({ search:value, resetPage:true }), 180);
  localSearchInput.addEventListener("input", e => onSearchChange(e.target.value));
}
if(localStatusFilter){
  localStatusFilter.addEventListener("change", e => queueTableRefresh({ status:e.target.value, resetPage:true }));
}
if(localPageSizeSelect){
  localPageSizeSelect.addEventListener("change", e => queueTableRefresh({ pageSize:e.target.value, resetPage:true }));
}
if(localPrevPage){
  localPrevPage.addEventListener("click", ()=>{
    queueTableRefresh({ page: tableState.page - 1 });
  });
}
if(localNextPage){
  localNextPage.addEventListener("click", ()=>{
    queueTableRefresh({ page: tableState.page + 1 });
  });
}
document.querySelectorAll('#localTable thead th[data-sort]').forEach(th => {
  th.addEventListener("click", ()=>{
    const key = th.dataset.sort;
    if(!key) return;
    let dir = "asc";
    if(tableState.sortBy === key){
      dir = tableState.sortDir === "asc" ? "desc" : "asc";
    }
    queueTableRefresh({ sortBy:key, sortDir:dir });
  });
});

openAdd.addEventListener("click", async ()=>{
  const arr = (await idbGet(IDB_KEY_STATUS)) || [];
  populateStatusSelect(arr);
  if(window.bootstrap){
    m_id.value = "";
    if(m_serial_number) m_serial_number.value = "";
    if(m_asset_tag) m_asset_tag.value = "";
    if(m_type) m_type.value = "";
    if(m_model) m_model.value = "";
    if(m_room) m_room.value = "";
    m_assigned_to.value = "";
    m_status.value = "";
    m_status_custom.value = "";
    m_meta.value = "";
    const modal = new bootstrap.Modal(addModalEl); modal.show(); setTimeout(()=> m_id.focus(), 150);
  } else {
    fb_id.value = "";
    if(fb_serial_number) fb_serial_number.value = "";
    if(fb_asset_tag) fb_asset_tag.value = "";
    if(fb_type) fb_type.value = "";
    if(fb_model) fb_model.value = "";
    if(fb_room) fb_room.value = "";
    fb_assigned_to.value = "";
    fb_status.value = "";
    fb_status_custom.value = "";
    fb_meta.value = "";
    fbModalEl.classList.add('show'); fb_id.focus();
  }
});
if(fb_cancel){ fb_cancel.addEventListener("click", ()=> fbModalEl.classList.remove('show')); }
if(fb_confirm){ fb_confirm.addEventListener("click", ()=>{
  const id = norm(fb_id.value); if(!id){ alert("ID is required."); return; }
  const status = norm(fb_status.value) || norm(fb_status_custom.value);
  const row = {
    id,
    serial_number: norm(fb_serial_number?.value),
    asset_tag: norm(fb_asset_tag?.value),
    type: norm(fb_type?.value),
    model: norm(fb_model?.value),
    room: norm(fb_room?.value),
    assigned_to: norm(fb_assigned_to.value),
    status,
    meta: fb_meta.value.trim()
  };
  addRow(row); fbModalEl.classList.remove('show');
}); }

if(confirmAdd){ confirmAdd.addEventListener("click", ()=>{
  const id = norm(m_id.value); if(!id){ alert("ID is required."); return; }
  const status = norm(m_status.value) || norm(m_status_custom.value);
  const row = {
    id,
    serial_number: norm(m_serial_number?.value),
    asset_tag: norm(m_asset_tag?.value),
    type: norm(m_type?.value),
    model: norm(m_model?.value),
    room: norm(m_room?.value),
    assigned_to: norm(m_assigned_to.value),
    status,
    meta: m_meta.value.trim()
  };
  addRow(row); const modal = bootstrap.Modal.getInstance(addModalEl); modal?.hide();
}); }

// ======= Init (with migration) =======
(async function init(){
  // Status options
  let statuses = await idbGet(IDB_KEY_STATUS);
  if(!Array.isArray(statuses) || statuses.length===0){
    statuses = ["Disposed","Initial","Installed","Returned","Shipped","Stored"];
    await idbSet(IDB_KEY_STATUS, statuses);
  }
  const statusInputEl = document.getElementById('statusOptions');
  if(statusInputEl) statusInputEl.value = statuses.join(", ");
  const statusSavedEl = document.getElementById('statusSaved');
  if(statusSavedEl) statusSavedEl.textContent = `Loaded ${statuses.length} item(s)`;

  // Rows
  let rows = await idbGet(IDB_KEY_ROWS);
  if(Array.isArray(rows) && rows.length){
    rows = rows.map(upgradeRow);
    await idbSet(IDB_KEY_ROWS, rows);
  } else {
    try {
      const s = localStorage.getItem(LS_KEY_MIGRATION);
      if(s){
        const parsed = JSON.parse(s);
        if(Array.isArray(parsed) && parsed.length){
          rows = parsed.map(upgradeRow).filter(r => norm(r.id));
          if(rows.length){
            await idbSet(IDB_KEY_ROWS, rows);
          }
        }
      }
    } catch {}
    if(!Array.isArray(rows) || rows.length===0){
      rows = createSeedRows(100).map(upgradeRow);
      await idbSet(IDB_KEY_ROWS, rows);
    }
  }
  renderLocal(rows);
  updateLastSaved();
})();
</script>
</body>
</html>
